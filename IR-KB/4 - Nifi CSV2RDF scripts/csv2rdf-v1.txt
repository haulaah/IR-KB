import org.apache.commons.csv.*
import java.nio.charset.StandardCharsets

// Get the flow file
def flowFile = session.get()
if (!flowFile) return

try {
    // Process the CSV and generate RDF
    flowFile = session.write(flowFile, { inputStream, outputStream -> 
        def reader = new InputStreamReader(inputStream, StandardCharsets.UTF_8)
        def writer = new OutputStreamWriter(outputStream, StandardCharsets.UTF_8)
        
        // Parse CSV with header
        def parser = CSVFormat.DEFAULT
            .withFirstRecordAsHeader()
            .withIgnoreEmptyLines()
            .withTrim()
            .parse(reader)

        // Write RDF header
        writer.write("""@prefix csiho: <http://gb.moreira.nom.br/csiho.owl#> . 
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> . 
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> . 
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> . 
""")

        // Process each record
        parser.records.each { record ->
            def date = record.get('Created')
            def userId = record.get('User_ID')
            def userEmail = record.get('User_Email')
            def orgName = record.get('Org_Name')
            def action = record.get('Action')
            def model = record.get('Model')
            def modelTitle = record.get('Model_Title')
            def eventId = record.get('Event_ID')
            def title = record.get('Title')

            // Create URI
            def uri = "<http://example.org/security/event/${eventId}>"

            // Write RDF triples
            writer.write("${uri} a csiho:Security_Event, csiho:Incident")

            // Add specific event type based on model or title
            if (modelTitle?.toLowerCase()?.contains("malicious")) writer.write(", csiho:Antivirus_Event")
            if (modelTitle?.toLowerCase()?.contains("network")) writer.write(", csiho:Network_Event")
            if (modelTitle?.toLowerCase()?.contains("phishing")) writer.write(", csiho:Proxy_Event")

            writer.write(" ;\n")
            writer.write("    csiho:hasID \"${eventId}\" ;\n")
            writer.write("    rdfs:label \"${title.replace('"', '\\"')}\" ;\n")
            writer.write("    csiho:hasDate \"${date}\"^^xsd:date ;\n")
            writer.write("    csiho:hasUserID \"${userId}\" ;\n")
            writer.write("    csiho:hasUserEmail \"${userEmail.replace('"', '\\"')}\" ;\n")
            writer.write("    csiho:hasOrgName \"${orgName.replace('"', '\\"')}\" ;\n")
            writer.write("    csiho:hasAction \"${action}\" ;\n")
            writer.write("    csiho:hasModel \"${model}\" .\n\n")
        }

        writer.flush()
    } as StreamCallback)

    session.transfer(flowFile, REL_SUCCESS)
} catch (Exception e) {
    log.error("Processing failed: ${e.message}", e)
    session.transfer(flowFile, REL_FAILURE)
}